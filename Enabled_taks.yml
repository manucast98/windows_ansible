---
- name: Habilitar tareas de cierre
  hosts: all
  become: false
  gather_facts: true
  tasks:

    - name: Reporte tareas programadas
      ansible.windows.win_powershell:
        script: |
          Get-ScheduledTask | Where-Object -Property TaskName -match '{{ item }}' | Select-Object -Property TaskName,State
      loop:
        - CSP_ScheduledSettlements_06am
      register: task_state

    - name: Get information about a task in the root folder
      community.windows.win_scheduled_task_stat:
        name: CSP_ScheduledSettlements_06am
      register: task_stat

    - name: Log de tareas activas
      debug:
        msg: "{{ task_stat.state.status }}"
