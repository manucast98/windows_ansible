---
- name: Estado de los discos
  hosts: all
  gather_facts: yes
  tasks:

  # Estado de los discos
  
  - name: Generating file
    ansible.windows.win_powershell:
      script: |
        Get-WmiObject -Class Win32_LogicalDisk |
        Select-Object -Property DeviceID, VolumeName, @{Label="FreeSpace (Gb)"; expression={($_.FreeSpace/1GB).ToString('F2')}},
        @{Label="Total (Gb)"; expression={($_.Size/1GB).ToString('F2')}},
        @{label="FreePercent"; expression={[Math]::Round(($_.freespace / $_.size) * 100, 2)}}|ft | ConvertTo-Json >> C:\Users\AppData\Local\Temp\ansibleLogs\disk_info_{{ansible_date_time.date}}.txt

  - name: Check status
    ansible.windows.win_powershell:
      script: |
        Get-Volume | select DriveLetter,HealthStatus,Size,SizeRemaining 
    register: output_var
  
  - debug:
      msg:
        - "Disco: {{ output_var.output[ansible_loop.index0 - 1].DriveLetter }}"
        - "Estado: {{ output_var.output[ansible_loop.index0 - 1].HealthStatus }}"
        - "Size MB: {{ output_var.output[ansible_loop.index0 - 1].Size }}"
        - "SizeRemaining MB: {{ output_var.output[ansible_loop.index0 - 1].SizeRemaining }}"
    loop: "{{ output_var.output }}"
    loop_control:
      extended: true
      label: "{{ ansible_loop.index0 }}"



